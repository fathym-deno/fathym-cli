import type { CLIInitFn } from '@fathym/cli';

/**
 * Example service interface for dependency injection.
 */
export interface SayHello {
  Speak(name: string): string;
}

/**
 * Default implementation of SayHello service.
 */
export class DefaultSayHello implements SayHello {
  Speak(name: string): string {
    return `Hello, ${name}!`;
  }
}

/**
 * CLI initialization hook.
 *
 * This function runs once when the CLI starts, before command execution.
 *
 * @param ioc - IoC container for registering shared services
 * @param config - CLI configuration from .cli.json
 * @param initCommand - Builder for the Init Command (optional pre-command hook)
 *
 * Use cases:
 * - Register shared services via IoC container
 * - Configure the Init Command for pre-command logic
 *
 * The Init Command runs before EVERY command and receives full context about
 * the matched command. You must call `Commands.$Command()` to execute it.
 */
export default ((ioc, _config, initCommand) => {
  // ═══════════════════════════════════════════════════════════════════════════
  // IoC Service Registration
  // Register shared services that can be injected into commands
  // ═══════════════════════════════════════════════════════════════════════════

  ioc.Register(() => new DefaultSayHello(), {
    Type: ioc.Symbol('SayHello'),
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // Init Command Configuration (Optional)
  // Uncomment to enable pre-command hooks for all commands
  // ═══════════════════════════════════════════════════════════════════════════

  // initCommand
  //   // Register services available in Init Command context
  //   .Services(async () => ({
  //     // Example: VersionChecker: new VersionChecker(),
  //   }))
  //   // Define the init command logic
  //   .Run(async ({ Services, Config, Log, Commands, Params }) => {
  //     // ─────────────────────────────────────────────────────────────────────
  //     // PRE-COMMAND LOGIC
  //     // Runs before the matched command executes
  //     // ─────────────────────────────────────────────────────────────────────
  //
  //     // Access matched command context via Params
  //     Log.Debug(`Executing: ${Params.Details.key}`);
  //
  //     // Example: Version check warning
  //     // if (Services.VersionChecker.hasUpdate()) {
  //     //   Log.Warn('A newer version is available');
  //     // }
  //
  //     // Example: Authentication gate
  //     // if (Params.Details.key.startsWith('admin/')) {
  //     //   if (!await checkAuth()) {
  //     //     Log.Error('Authentication required');
  //     //     return 1; // Block command execution
  //     //   }
  //     // }
  //
  //     // ─────────────────────────────────────────────────────────────────────
  //     // EXECUTE MATCHED COMMAND
  //     // IMPORTANT: Must call $Command() or the command never runs!
  //     // ─────────────────────────────────────────────────────────────────────
  //
  //     const exitCode = await Commands.$Command();
  //
  //     // ─────────────────────────────────────────────────────────────────────
  //     // POST-COMMAND LOGIC
  //     // Runs after the matched command completes
  //     // ─────────────────────────────────────────────────────────────────────
  //
  //     // Example: Telemetry logging
  //     // await telemetry.track({ command: Params.Details.key, exitCode });
  //
  //     // Return the exit code (can be modified if needed)
  //     return exitCode;
  //   });
}) as CLIInitFn;
