---
FrontmatterVersion: 1
DocumentType: Concept
Title: Configuration
Summary: Understanding CLI project structure and .cli.json configuration.
Created: 2025-11-29
Updated: 2025-11-29
Owners:
  - fathym
References:
  - Label: Documentation Index
    Path: ../README.mdx
  - Label: ftm init
    Path: ../api/init.mdx
  - Label: CLI Lifecycle
    Path: ./cli-lifecycle.mdx
---

# Configuration

Every Fathym CLI project is driven by a declarative configuration. This page explains the project structure and configuration files.

## Project Structure

After `ftm init`, your project looks like this:

```txt
my-cli/
├── .cli.json          # Primary config (tokens, paths, etc.)
├── .cli.init.ts       # Optional init hook (IoC, services)
├── deno.jsonc         # Deno tooling config
├── commands/          # Command implementations
├── intents/           # Intent-driven CLI tests
├── templates/         # Optional scaffolding templates
├── .gitignore         # Preconfigured for builds
└── .vscode/           # IDE configuration (optional)
```

## File Reference

| File / Folder | Purpose | Created By | Editable |
|---------------|---------|------------|----------|
| `.cli.json` | CLI identity and config | `ftm init` | Yes |
| `.cli.init.ts` | IoC initialization hook | `ftm init` | Yes |
| `commands/` | Command logic | `ftm init` | Yes |
| `intents/` | Command tests | `ftm init` | Yes |
| `templates/` | Scaffolding templates | Manual | Yes |
| `.build/` | Embedded CLI output | `ftm build` | No |
| `.dist/` | Native binary output | `ftm compile` | No |
| `.temp/` | Runtime cache | dev/test flows | No |

## .cli.json

The root configuration file defining CLI identity:

```json
{
  "Name": "My CLI",
  "Tokens": ["my-cli", "mc"],
  "Version": "1.0.0",
  "Description": "My awesome CLI tool",
  "Commands": "./commands",
  "ConfigDFSName": ".my-cli"
}
```

### Properties

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `Name` | string | Yes | Display name for help output |
| `Tokens` | string[] | Yes | CLI entry point names (first is primary) |
| `Version` | string | Yes | Semantic version |
| `Description` | string | No | Brief description |
| `Commands` | string \| string[] \| CLICommandSource[] | No | Commands directory (default: `./commands`) |
| `Templates` | string | No | Templates directory (default: `./templates`) |
| `ConfigDFSName` | string | No | Config directory name (e.g., `.my-cli`) - enables ConfigDFS |
| `ConfigDFSRoot` | string | No | Explicit root for config directory |
| `ConfigDFSRootEnvVar` | string | No | Env var name for root override, or "" to disable |
| `Release` | ReleaseConfig | No | Cross-compilation release configuration |

### Tokens

The `Tokens` array defines how users invoke your CLI:

```json
{
  "Tokens": ["my-cli", "mc"]
}
```

- First token (`my-cli`) becomes the primary binary name
- Additional tokens (`mc`) become aliases during install

### ConfigDFS

The ConfigDFS settings enable user configuration storage:

```json
{
  "ConfigDFSName": ".my-cli",
  "ConfigDFSRoot": "/opt/config",
  "ConfigDFSRootEnvVar": "MYCLI_CONFIG_DIR"
}
```

**Root Resolution Precedence:**

| Priority | Source | Example |
|----------|--------|---------|
| 1 | Custom env var (`ConfigDFSRootEnvVar`) | `MYCLI_CONFIG_DIR=/data` |
| 2 | Explicit root (`ConfigDFSRoot`) | `"/opt/config"` |
| 3 | Default env var (`{TOKEN}_CONFIG_ROOT`) | `MYCLI_CONFIG_ROOT=/alt` |
| 4 | User home directory | `~/.my-cli/` |

See [ftm cli config](../api/config.mdx) for config commands.

### Release Configuration

Configure cross-compilation targets for releases:

```json
{
  "Release": {
    "Targets": ["x86_64-pc-windows-msvc", "x86_64-apple-darwin"],
    "DefaultInstallDir": {
      "unix": "~/.local/bin",
      "windows": "~/.bin"
    }
  }
}
```

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `Release.Targets` | string[] | All 5 platforms | Target platforms to compile |
| `Release.DefaultInstallDir.unix` | string | `~/.bin` | Default install dir for Unix |
| `Release.DefaultInstallDir.windows` | string | `~/.bin` | Default install dir for Windows |

See [ftm cli release](../api/release.mdx) for release workflow.

## .cli.init.ts

Optional bootstrap hook that runs before any command dispatches. The function receives three parameters:

```typescript
import type { CLIInitFn } from '@fathym/cli';

export default ((ioc, config, initCommand) => {
  // Register shared services
  ioc.Register(MyService, () => new MyService());

  // Configure logging
  ioc.Register('LogLevel', () => 'debug');

  // Configure Init Command (optional)
  initCommand
    .Services(async () => ({
      VersionChecker: new VersionChecker(),
    }))
    .Run(async ({ Services, Log, Commands }) => {
      // Pre-command logic (version check, auth, etc.)
      await Services.VersionChecker.warnIfOutdated();

      // Execute the matched command
      return await Commands.$Command();
    });
}) as CLIInitFn;
```

### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `ioc` | `IoCContainer` | IoC container for service registration |
| `config` | `CLIConfig` | CLI configuration from `.cli.json` |
| `initCommand` | `InitCommandBuilder` | Builder for the Init Command hook |

### Use Cases

**IoC Registration:**
- Inject shared services into IoC container
- Set logging/debug modes
- Register dynamic runtime behaviors

**Init Command:**
- Version update warnings
- Authentication/authorization gates
- Command telemetry and logging
- Pre-flight validation

### Init Command

The `initCommand` parameter is an `InitCommandBuilder` that configures a hook running before every command. Key features:

- **Must call `$Command()`**: Without this, the matched command never executes
- **Services merge**: Multiple `.Services()` calls are merged together
- **Exit code control**: The Init Command returns the final exit code

For `ftm`, the Init Command checks for updates and warns users:

```typescript
initCommand
  .Services(() => Promise.resolve({
    VersionResolver: new VersionResolver(),
    VersionComparator: new VersionComparator(),
  }))
  .Run(async ({ Services, Config, Log, Commands }) => {
    const { VersionResolver, VersionComparator } = Services;

    try {
      const versions = await VersionResolver.getVersionsByChannel('jsr', '@fathym/ftm');
      const latest = versions.get('production')?.[0]?.version;

      if (latest && VersionComparator.compare(Config.Version, latest) < 0) {
        Log.Warn(`A newer version is available: ${latest}`);
        Log.Warn(`  Current: ${Config.Version}`);
        Log.Warn(`  Upgrade: ftm upgrade`);
        Log.Warn('');
      }
    } catch {
      // Silently ignore network errors
    }

    return await Commands.$Command();
  });
```

## commands/

Each file exports a command:

```typescript
// commands/hello.ts
import { Command } from '@fathym/cli';
import { z } from 'zod';

export default Command('hello', 'Prints a greeting')
  .Args(z.tuple([z.string().optional()]))
  .Run(({ Params, Log }) => {
    Log.Info(`Hello, ${Params.Arg(0) ?? 'World'}!`);
  });
```

Commands are discovered automatically by the CLI runtime.

## intents/

Declarative tests for CLI behavior:

```typescript
// intents/hello.intents.ts
import { CommandIntents } from '@fathym/cli';

CommandIntents('my-cli hello', ({ Intent }) => {
  Intent('greets with default')
    .Args([])
    .ExpectLogs(['Hello, World!'])
    .ExpectExit(0);
});
```

Run with `ftm test` or `deno test`.

## templates/

Optional scaffolding templates using Handlebars syntax:

```txt
templates/
└── component/
    ├── {{name}}.ts.hbs
    └── {{name}}.test.ts.hbs
```

Templates are used when you add generator commands to your CLI.

## deno.jsonc

Local Deno configuration (not used by CLI runtime):

```json
{
  "name": "@my-org/my-cli",
  "version": "1.0.0",
  "imports": {
    "@fathym/cli": "jsr:@fathym/cli@0.0.162-InitCommand"
  },
  "tasks": {
    "build": "deno task fmt && deno task lint && deno task test",
    "test": "deno test -A"
  }
}
```

## Build Output

During build and compile, these directories are created:

```txt
my-cli/
├── .build/                      # Generated by `ftm build`
│   ├── cli.ts                   # Entry module
│   ├── EmbeddedCommandModules.ts
│   ├── EmbeddedCLIFileSystemHooks.ts
│   ├── embedded-templates.json
│   └── embedded-command-entries.json
├── .dist/                       # Generated by `ftm compile`
│   └── my-cli                   # Native binary
└── .temp/                       # Ephemeral runtime cache
```

These directories should be in `.gitignore`.

## Related

- [ftm init](../api/init.mdx) - Project initialization
- [CLI Lifecycle](./cli-lifecycle.mdx) - Build/compile workflow
- [Templates](./templates.mdx) - Scaffolding system
